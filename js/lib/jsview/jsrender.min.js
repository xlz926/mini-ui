(function(global,jQuery,undefined){"use strict";if(jQuery&&jQuery.views||global.jsviews){return}var versionNumber="v1.0pre",$,jsvStoreName,rTag,rTmplString,delimOpenChar0="{",delimOpenChar1="{",delimCloseChar0="}",delimCloseChar1="}",linkChar="^",FALSE=false,TRUE=true,rPath=/^(?:null|true|false|\d[\d.]*|([\w$]+|\.|~([\w$]+)|#(view|([\w$]+))?)([\w$.^]*?)(?:[.[^]([\w$]+)\]?)?)$/g,rParams=/(\()(?=|\s*\()|(?:([([])\s*)?(?:([#~]?[\w$.^]+)?\s*((\+\+|--)|\+|-|&&|\|\||===|!==|==|!=|<=|>=|[<>%*!:?\/]|(=))\s*|([#~]?[\w$.^]+)([([])?)|(,\s*)|(\(?)\\?(?:(')|("))|(?:\s*([)\]])([([]?))|(\s+)/g,rNewLine=/\r?\n/g,rUnescapeQuotes=/\\(['"])/g,rEscapeQuotes=/([\\'"])/g,rBuildHash=/\x08(~)?([^\x08]+)\x08/g,rTestElseIf=/^if\s/,rFirstElem=/<(\w+)[>\s]/,rPrevElem=/<(\w+)[^>\/]*>[^>]*$/,autoTmplName=0,viewId=0,escapeMapForHtml={"&":"&amp;","<":"&lt;",">":"&gt;"},attrEncodeChars=/[<"'&]/g,htmlEncodeChars=/[\x00<>"'&]/g,tmplAttr="data-jsv-tmpl",fnDeclStr="var j=j||"+(jQuery?"jQuery.":"js")+"views,",slice=[].slice,$render={},jsvStores={template:{compile:compileTmpl},tag:{compile:compileTag},helper:{},converter:{}},$views={jsviews:versionNumber,render:$render,View:View,settings:{delimiters:$viewsDelimiters,debugMode:TRUE,tryCatch:TRUE},sub:{Error:JsViewsError,tmplFn:tmplFn,parse:parseParams,extend:$extend,error:error},_cnvt:convertVal,_tag:renderTag,_err:function(e){return $viewsSettings.debugMode?"Error: "+(e.message||e)+". ":""}};function JsViewsError(message,object){if(object&&object.onError){if(object.onError(message)===FALSE){return}}this.name="JsRender Error";this.message=message||"JsRender error"}function $extend(target,source){var name;target=target||{};for(name in source){target[name]=source[name]}return target}(JsViewsError.prototype=new Error).constructor=JsViewsError;function $viewsDelimiters(openChars,closeChars,link){if(!$viewsSub.rTag||arguments.length){delimOpenChar0=openChars?openChars.charAt(0):delimOpenChar0;delimOpenChar1=openChars?openChars.charAt(1):delimOpenChar1;delimCloseChar0=closeChars?closeChars.charAt(0):delimCloseChar0;delimCloseChar1=closeChars?closeChars.charAt(1):delimCloseChar1;linkChar=link||linkChar;openChars="\\"+delimOpenChar0+"(\\"+linkChar+")?\\"+delimOpenChar1;closeChars="\\"+delimCloseChar0+"\\"+delimCloseChar1;rTag="(?:(?:(\\w+(?=[\\/\\s\\"+delimCloseChar0+"]))|(?:(\\w+)?(:)|(>)|!--((?:[^-]|-(?!-))*)--|(\\*)))"+"\\s*((?:[^\\"+delimCloseChar0+"]|\\"+delimCloseChar0+"(?!\\"+delimCloseChar1+"))*?)";$viewsSub.rTag=rTag+")";rTag=new RegExp(openChars+rTag+"(\\/)?|(?:\\/(\\w+)))"+closeChars,"g");rTmplString=new RegExp("<.*>|([^\\\\]|^)[{}]|"+openChars+".*"+closeChars)}return[delimOpenChar0,delimOpenChar1,delimCloseChar0,delimCloseChar1,linkChar]}function getView(type){var view=this,root=!type||type==="root";while(root&&view.parent.parent||view&&view.type!==type){view=view.parent}return view}function getIndex(){var view=this.get("item");return view?view.index:undefined}getIndex.depends=function(view){return[view.get("item"),"index"]};function getHelper(helper){var wrapped,view=this,res=(view.ctx||{})[helper];res=res===undefined?view.getRsc("helpers",helper):res;if(res){if(typeof res==="function"){wrapped=function(){return res.apply(view,arguments)};$extend(wrapped,res)}}return wrapped||res}function convertVal(converter,view,self,tagCtx,bindingPaths,text){if(converter||bindingPaths){var tmplConverter,linkCtx=!self.markup&&self,tag={tagName:converter+":",tagCtx:tagCtx},args=tagCtx.args=slice.call(arguments,5);tagCtx.view=view;tagCtx.bind=!!(linkCtx||bindingPaths);if(linkCtx){linkCtx.tag=tag;tag.linkCtx=linkCtx;tagCtx.ctx=extendCtx(tagCtx.ctx,linkCtx.view.ctx)}tag.ctx=tagCtx.ctx||{};tagCtx.props=tagCtx.props||{};delete tagCtx.ctx;if(converter&&((tmplConverter=view.getRsc("converters",converter))||error("Unknown converter: {{"+converter+":"))){text=tmplConverter.apply(tag,args)}if(bindingPaths){bindingPaths=view.tmpl.bnds[bindingPaths-1];linkCtx.paths=bindingPaths;view._.tag=tag;text=view._.onRender(text,view,TRUE)}}return text}function getResource(storeName,item){var res,view=this,store=$views[storeName];res=store&&store[item];while(res===undefined&&view){store=view.tmpl[storeName];res=store&&store[item];view=view.parent}return res}function getResource2(storeName,item,root){var view=this,store=!root&&$views[storeName];return store&&store[item]||(store=view.tmpl[storeName],store&&store[item])||view.parent&&view.parent.getRsc(storeName,item,TRUE)}function renderTag(tagName,parentView,self,content,tagCtx,bind){var ret,render,ctx,elses,tag,tags,tmpl=self.markup&&self,linkCtx=!tmpl&&self,parentView_=parentView._,parentTmpl=tmpl||parentView.tmpl,childTemplates=parentTmpl.templates,tagDef=parentView.getRsc("tags",tagName)||error("Unknown tag: {{"+tagName+"}}"),args=tagCtx.args=arguments.length>6?slice.call(arguments,6):[],props=tagCtx.props=tagCtx.props||{};tagCtx.view=parentView;tagCtx.ctx=extendCtx(tagCtx.ctx,parentView.ctx);ctx=tagCtx.ctx||{};delete tagCtx.ctx;tmpl=props.tmpl;content=content&&parentTmpl.tmpls[content-1];tmpl=tmpl||content||tagDef.template||undefined;tmpl=""+tmpl===tmpl?parentView.getRsc("templates",tmpl)||$templates(tmpl):tmpl;if(tagName==="else"){tag=parentView._.tag;elses=tag._elses=tag._elses||[];elses.push(tmpl);tagCtx.isElse=elses.length;render=tag.render}if(tagDef.init){tags=ctx.tags=parentView.ctx&&extendCtx(ctx.tags,parentView.ctx.tags)||{};tag=tag||linkCtx.tag;if(tag){tags[tagName]=tag}else{tag=tags[tagName]=new tagDef.init(tagCtx,linkCtx,ctx);tag.tmpl=tmpl;if(linkCtx){tag.attr=linkCtx.attr=linkCtx.attr||tagDef.attr||""}}ctx.tag=tag}else{tag=tag||{render:tagDef.render,renderContent:renderContent,tmpl:tmpl,tagName:tagName}}tag.tagCtx=tagCtx;tag.ctx=ctx;if(linkCtx){linkCtx.tag=tag;tag.linkCtx=linkCtx}tag._is="tag";tag._done=tagCtx.isElse?tag._done:FALSE;tmpl=tmpl||tag.tmpl;elses=tag._elses;parentView_.tag=tag;if(render=render||tag.render){ret=render.apply(tag,args)}ret=ret!==undefined?ret:tmpl?tag.renderContent(tagCtx.data!==undefined?tagCtx.data:parentView.data,undefined,parentView):"";return bind?parentView_.onRender(ret,parentView,bind):ret}function View(context,type,parentView,data,template,key,onRender){var views,parentView_,isArray=type==="array",self_={key:0,useKey:isArray?0:1,id:""+viewId++,onRender:onRender,bnd:{}},self={data:data,tmpl:template,views:isArray?[]:{},parent:parentView,ctx:context,type:type,get:getView,getIndex:getIndex,getRsc:getResource,_hlp:getHelper,_:self_};if(parentView){views=parentView.views;parentView_=parentView._;if(parentView_.useKey){views[self_.key="_"+parentView_.useKey++]=self}else{views.splice(self_.key=self.index=key!==undefined?key:views.length,0,self)}self.ctx=context||parentView.ctx}return self}function compileChildResources(parentTmpl){var storeName,resources,resourceName,settings,compile;for(storeName in jsvStores){settings=jsvStores[storeName];if((compile=settings.compile)&&(resources=parentTmpl[storeName+"s"])){for(resourceName in resources){resources[resourceName]=compile(resourceName,resources[resourceName],parentTmpl,storeName,settings)}}}}function compileTag(name,item,parentTmpl){var init,tmpl;if(typeof item==="function"){item={tagName:name,render:item,depends:item.depends}}else{item.tagName=name;if(tmpl=item.template){item.template=""+tmpl===tmpl?$templates[tmpl]||$templates(tmpl):tmpl}if(item.init!==FALSE){init=item.init=item.init||function(tagCtx){};init.prototype=item;(init.prototype=item).constructor=init}}item.renderContent=renderContent;item.attr="html";if(parentTmpl){item._parentTmpl=parentTmpl}return item}function compileTmpl(name,tmpl,parentTmpl,storeName,storeSettings,options){function tmplOrMarkupFromStr(value){if(""+value===value||value.nodeType>0){try{elem=value.nodeType>0?value:!rTmplString.test(value)&&jQuery&&jQuery(value)[0]}catch(e){}if(elem){value=elem.getAttribute(tmplAttr);name=name||value;value=$templates[value];if(!value){name=name||"_"+autoTmplName++;elem.setAttribute(tmplAttr,name);value=$templates[name]=compileTmpl(name,elem.innerHTML,parentTmpl,storeName,storeSettings,options)}}return value}}var tmplOrMarkup,elem;tmpl=tmpl||"";tmplOrMarkup=tmplOrMarkupFromStr(tmpl);options=options||(tmpl.markup?tmpl:{});options.tmplName=name;if(parentTmpl){options._parentTmpl=parentTmpl}if(!tmplOrMarkup&&tmpl.markup&&(tmplOrMarkup=tmplOrMarkupFromStr(tmpl.markup))){if(tmplOrMarkup.fn&&(tmplOrMarkup.debug!==tmpl.debug||tmplOrMarkup.allowCode!==tmpl.allowCode)){tmplOrMarkup=tmplOrMarkup.markup}}if(tmplOrMarkup!==undefined){if(name&&!parentTmpl){$render[name]=function(){return tmpl.render.apply(tmpl,arguments)}}if(tmplOrMarkup.fn||tmpl.fn){if(tmplOrMarkup.fn){if(name&&name!==tmplOrMarkup.tmplName){tmpl=extendCtx(options,tmplOrMarkup)}else{tmpl=tmplOrMarkup}}}else{tmpl=TmplObject(tmplOrMarkup,options);tmplFn(tmplOrMarkup,tmpl)}compileChildResources(options);return tmpl}}function TmplObject(markup,options){var htmlTag,wrapMap=$viewsSettings.wrapMap||{},tmpl=$extend({markup:markup,tmpls:[],links:{},bnds:[],render:renderContent},options);if(!options.htmlTag){htmlTag=rFirstElem.exec(markup);tmpl.htmlTag=htmlTag?htmlTag[1].toLowerCase():""}htmlTag=wrapMap[tmpl.htmlTag];if(htmlTag&&htmlTag!==wrapMap.div){tmpl.markup=$.trim(tmpl.markup);tmpl._elCnt=TRUE}return tmpl}function registerStore(storeName,storeSettings){function theStore(name,item,parentTmpl){var onStore,compile,items,itemName,childTemplates,childTemplate,thisStore,childStoreName;if(name&&""+name!==name&&!name.nodeType&&!name.markup){for(itemName in name){theStore(itemName,name[itemName],item)}return $views}thisStore=parentTmpl?parentTmpl[storeNames]=parentTmpl[storeNames]||{}:theStore;if(item===undefined){item=name;name=undefined}compile=storeSettings.compile;if(onStore=$viewsSub.onBeforeStoreItem){compile=onStore(thisStore,name,item,compile)||compile}if(!name){item=compile(undefined,item)}else if(""+name===name){if(item===null){delete thisStore[name]}else{thisStore[name]=compile?item=compile(name,item,parentTmpl,storeName,storeSettings):item}}if(item){item._is=storeName}if(onStore=$viewsSub.onStoreItem){onStore(thisStore,name,item,compile)}return item}var storeNames=storeName+"s";$views[storeNames]=theStore;jsvStores[storeName]=storeSettings}function renderContent(data,context,parentView,key,isLayout,onRender){var i,l,dataItem,newView,childView,itemResult,parentContext,props,swapContent,tagCtx,isTag,outerOnRender,self=this,tmpl=self,allowDataLink=self.attr===undefined||self.attr==="html",result="";if(key===TRUE){swapContent=TRUE;key=0}if(isTag=self._is==="tag"){tagCtx=self.tagCtx;tmpl=tagCtx.isElse?self._elses[tagCtx.isElse-1]:self.tmpl;context=extendCtx(context,self.ctx);props=tagCtx.props;if(props.link===FALSE){context=context||{};context.link=FALSE}parentView=parentView||tagCtx.view}else{tmpl=self.jquery&&(self[0]||error('Unknown template: "'+self.selector+'"'))||self}if(tmpl){if(parentView){onRender=onRender||parentView._.onRender;parentContext=parentView.ctx;if(data===parentView){data=parentView.data;isLayout=TRUE}}context=extendCtx(context,parentContext);if(!tmpl.fn){tmpl=$templates[tmpl]||$templates(tmpl)}if(tmpl){onRender=(context&&context.link)!==FALSE&&allowDataLink&&onRender;outerOnRender=onRender;if(onRender===TRUE){outerOnRender=undefined;onRender=parentView._.onRender}if($.isArray(data)&&!isLayout){newView=swapContent?parentView:key!==undefined&&parentView||View(context,"array",parentView,data,tmpl,key,onRender);for(i=0,l=data.length;i<l;i++){dataItem=data[i];childView=View(context,"item",newView,dataItem,tmpl,(key||0)+i,onRender);itemResult=tmpl.fn(dataItem,childView,$views);result+=newView._.onRender?newView._.onRender(itemResult,childView):itemResult}}else{newView=swapContent?parentView:View(context,self.tagName||"data",parentView,data,tmpl,key,onRender);result+=tmpl.fn(data,newView,$views)}return outerOnRender?outerOnRender(result,newView):result}}return""}function error(message){if($viewsSettings.debugMode){throw new $views.sub.Error(message)}}function syntaxError(message){error("Syntax error\n"+message)}function tmplFn(markup,tmpl,isLinkExpression){function pushprecedingContent(shift){shift-=loc;if(shift){content.push(markup.substr(loc,shift).replace(rNewLine,"\\n"))}}function blockTagCheck(tagName){tagName&&syntaxError('Unmatched or missing tag: "{{/'+tagName+'}}" in template:\n'+markup)}function parseTag(all,bind,tagName,converter,colon,html,comment,codeTag,params,slash,closeBlock,index){if(html){colon=":";converter="html"}var noError,current0,pathBindings=[],code="",hash="",passedCtx="",block=!slash&&!colon&&!comment&&!isLinkExpression;tagName=tagName||colon;pushprecedingContent(index);loc=index+all.length;if(codeTag){if(allowCode){content.push(["*","\n"+params.replace(rUnescapeQuotes,"$1")+"\n"])}}else if(tagName){if(tagName==="else"){if(rTestElseIf.test(params)){syntaxError('for "{{else if expr}}" use "{{else expr}}"')}current[7]=markup.substring(current[7],index);current=stack.pop();content=current[3];block=TRUE}if(params){params=params.replace(/\s*\n\s*/g," ");code=parseParams(params,pathBindings).replace(rBuildHash,function(all,isCtx,keyValue){if(isCtx){passedCtx+=keyValue+","}else{hash+=keyValue+","}return""})}hash=hash.slice(0,-1);code=code.slice(0,-1);noError=hash&&hash.indexOf("noerror:true")+1&&hash||"";newNode=[tagName,converter||"",code,block&&[],"{"+(hash?"props:"+(noError?"hsh":"{"+hash+"}")+",":"")+'params:"'+params+'"'+(passedCtx?",ctx:{"+passedCtx.slice(0,-1)+"}":"")+"},",noError,bind&&pathBindings||0];content.push(newNode);if(block){stack.push(current);current=newNode;current[7]=loc}}else if(closeBlock){current0=current[0];blockTagCheck(closeBlock!==current0&&current0&&current0!=="else");current[7]=markup.substring(current[7],index);current=stack.pop()}blockTagCheck(!current&&closeBlock);content=current[3]}var newNode,allowCode=tmpl&&tmpl.allowCode,astTop=[],loc=0,stack=[],content=astTop,current=[,,,astTop];markup=markup.replace(rEscapeQuotes,"\\$1");blockTagCheck(stack[0]&&stack[0][3].pop()[0]);markup.replace(rTag,parseTag);pushprecedingContent(markup.length);if(loc=astTop[astTop.length-1]){blockTagCheck(""+loc!==loc&&+loc[7]===loc[7]&&loc[0])}return buildCode(astTop,tmpl)}function buildCode(ast,tmpl){var ret,i,node,hasTag,noError,hasEncoder,getsValue,hasConverter,hasViewPath,tagName,converter,params,hash,bindings,bindingPaths,nestedTmpls,nestedTmpl,allowCode,content,markup,code="",tmplOptions={},l=ast.length;if(tmpl){if(allowCode=tmpl.allowCode){tmplOptions.allowCode=TRUE}if(tmpl.debug){tmplOptions.debug=TRUE}bindings=tmpl.bnds;nestedTmpls=tmpl.tmpls}for(i=0;i<l;i++){node=ast[i];ret="";if(""+node===node){ret='ret+="'+node+'";'}else{tagName=node[0];if(tagName==="*"){ret=""+node[1]}else{converter=node[1];params=node[2];content=node[3];hash=node[4];noError=node[5];bindingPaths=node[6];markup=node[7];if(content){nestedTmpl=TmplObject(markup,tmplOptions);buildCode(content,nestedTmpl);nestedTmpls.push(nestedTmpl)}if(bindingPaths){bindings.push(bindingPaths);bindingPaths=bindings.length}hasViewPath=hasViewPath||hash.indexOf("view")>-1;if(noError){noError="try{prm="+params+";hsh={"+noError+'};}catch(e){prm="";hsh={};}\n';params="prm"}ret+=noError+"ret+="+(tagName===":"?converter==="html"&&!bindingPaths?(hasEncoder=TRUE,"h("+params+");"):converter||bindingPaths?(hasConverter=TRUE,'c("'+converter+'",view,this,'+hash+bindingPaths+","+params+");"):(getsValue=TRUE,"(v="+params+')!=u?v:"";'):(hasTag=TRUE,'t("'+tagName+'",view,this,'+(content?nestedTmpls.length:'""')+","+hash+bindingPaths+(params?",":"")+params)+");")}}code+="\n"+ret}code=fnDeclStr+(noError?"prm,hsh,":"")+(getsValue?"v,":"")+(hasTag?"t=j._tag,":"")+(hasConverter?"c=j._cnvt,":"")+(hasEncoder?"h=j.converters.html,":"")+'ret="";\n'+($viewsSettings.tryCatch?"try{\n":"")+(tmplOptions.debug?"debugger;":"")+code+"\nreturn ret;\n"+($viewsSettings.tryCatch?"\n}catch(e){return j._err(e);}":"");try{code=new Function("data, view, j, u",code)}catch(e){syntaxError("Compiled template code:\n\n"+code,e)}if(tmpl){tmpl.fn=code}return code}function parseParams(params,bindings){function parseTokens(all,lftPrn0,lftPrn,path,operator,err,eq,path2,prn,comma,lftPrn2,apos,quot,rtPrn,prn2,space){operator=operator||"";lftPrn=lftPrn||lftPrn0||lftPrn2;path=path||path2;prn=prn||prn2||"";function parsePath(all,object,helper,view,viewProperty,pathTokens,leafToken){if(object){bindings.push(path);if(object!=="."){var leaf,ret=(helper?'view._hlp("'+helper+'")':view?"view":"data")+(leafToken?(viewProperty?"."+viewProperty:helper?"":view?"":"."+object)+(pathTokens||""):(leafToken=helper?"":view?viewProperty||"":object,""));leaf=leafToken?"."+leafToken:"";ret=ret+leaf;ret=ret.slice(0,9)==="view.data"?ret.slice(5):ret;return ret}}return all}if(err){syntaxError(params)}else{return aposed?(aposed=!apos,aposed?all:'"'):quoted?(quoted=!quot,quoted?all:'"'):(lftPrn?(parenDepth++,lftPrn):"")+(space?parenDepth?"":named?(named=FALSE,"\b"):",":eq?(parenDepth&&syntaxError(params),named=TRUE,"\b"+path+":"):path?path.split("^").join(".").replace(rPath,parsePath)+(prn?(fnCall[++parenDepth]=TRUE,prn):operator):operator?operator:rtPrn?(fnCall[parenDepth--]=FALSE,rtPrn)+(prn?(fnCall[++parenDepth]=TRUE,prn):""):comma?(fnCall[parenDepth]||syntaxError(params),","):lftPrn0?"":(aposed=apos,quoted=quot,'"'))}}var named,fnCall={},parenDepth=0,quoted=FALSE,aposed=FALSE;bindings.expr=params.replace(rUnescapeQuotes,"$1");return(params+" ").replace(rParams,parseTokens)}function replacerForHtml(ch){return escapeMapForHtml[ch]||(escapeMapForHtml[ch]="&#"+ch.charCodeAt(0)+";")}function extendCtx(context,parentContext){return context&&context!==parentContext?parentContext?$extend($extend({},parentContext),context):context:parentContext&&$extend({},parentContext)}for(jsvStoreName in jsvStores){registerStore(jsvStoreName,jsvStores[jsvStoreName])}var $templates=$views.templates,$converters=$views.converters,$helpers=$views.helpers,$tags=$views.tags,$viewsSub=$views.sub,$viewsSettings=$views.settings;if(jQuery){$=jQuery;$.render=$render;$.views=$views;$.templates=$templates=$views.templates;$.fn.render=renderContent}else{$=global.jsviews=$views;$.isArray=Array&&Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"}}$tags({"if":function(val){var self=this;return self._done||arguments.length&&!val?"":(self._done=true,self.renderContent(self.tagCtx.view))},"else":function(){},"for":function(){var i,arg,undef,self=this,tagCtx=self.tagCtx,result="",args=arguments,done=0,l=args.length;if(!l){return tagCtx.done?"":(tagCtx.done=TRUE,self.renderContent(tagCtx.view))}for(i=0;i<l;i++){arg=args[i];undef=arg===undefined;if(!undef){done+=$.isArray(arg)?arg.length:1;result+=self.renderContent(arg)}else{return""}}tagCtx.done=done;return result},"*":function(value){return value}});$converters({html:function(text){return text!=undefined?String(text).replace(htmlEncodeChars,replacerForHtml):""},attr:function(text){return text!=undefined?String(text).replace(attrEncodeChars,replacerForHtml):""},url:function(text){return text!=undefined?encodeURI(String(text)):""}});$viewsDelimiters()})(this,this.jQuery);